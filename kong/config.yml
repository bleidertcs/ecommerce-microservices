_format_version: "3.0"
_transform: true

services:
  - name: users-service
    url: http://bw-users-service:9001
    routes:
      - name: users-routes
        paths:
          - /api/v1/users
        strip_path: true
        protocols: ["http", "https"]
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE"]
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss
          - name: request-transformer
            config:
              add:
                headers:
                  - x-user-id:$(jwt_claim_sub)
          - name: rate-limiting
            config:
              minute: 60
              policy: redis
              limit_by: header
              header_name: x-user-id
              redis_host: redis
              redis_port: 6379

  - name: products-service
    url: http://bw-products-service:9002
    routes:
      - name: products-routes
        paths:
          - /api/v1/products
        strip_path: true
        protocols: ["http", "https"]
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE"]
        # Public catalog, protected management
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: redis
              limit_by: ip
              redis_host: redis
              redis_port: 6379

  - name: orders-service
    url: http://bw-orders-service:9003
    routes:
      - name: orders-routes
        paths:
          - /api/v1/orders
        strip_path: true
        protocols: ["http", "https"]
        methods: ["GET", "POST", "DELETE"]
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss
          - name: request-transformer
            config:
              add:
                headers:
                  - x-user-id:$(jwt_claim_sub)
          - name: rate-limiting
            config:
              minute: 30
              policy: redis
              limit_by: header
              header_name: x-user-id
              redis_host: redis
              redis_port: 6379

consumers:
  - username: test-user
    custom_id: user-123

jwt_secrets:
  - consumer: test-user
    key: http://localhost:9000/application/o/gateway-api/
    algorithm: RS256
    rsa_public_key: |
      -----BEGIN PUBLIC KEY-----
      MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAp/g77nAlVKcxavnP/dqV
      Clc0i8xIH08aPng7TfQ/FtxpF3lc+9RH0GV+Z+M+PEjHGBywMoWogG8c0X1gSOcI
      9CGgK1uz59jtFAH7y2Y+9objTCG7fGlB9r/HBKoMzgMkJAC5I9ygtNjI7CYpy5gX
      9lHf3SygsllUxlfm0JpInLYbDbaWGufDjlsSo+eMhncab91R8K4C+CwMMJdSa09V
      +A3A63sUsarUHbcXI6fpirlX9f/9vXtSt7aHoF65fslobi//pC8ojokj+tOXg70F
      L2FOLaaCgPHabh5EuBDsl3hcTPJovVHbfcHdlT8a65mX/JY30jG6Yt8HxapZM+aC
      VWHzkgbe2wyd+i8I9/KdCqcM2Me+045efKUJZNwTZ9Ih4Q95ThK9GhdWSUctlBqK
      GnzNi3Gy1X1jz0uTxEzueQ7bZded1KrmLiAS+MVNRFQZrKUa2kARAl6Q6n22RxWv
      olpWWfX/CVyTKdZ4QaRTdGTA7f+NXbvBj0L176haIBSAxnbi532Gm/QjjA/qxKkp
      2PaeBeE1dDYYxmILWhXD1XoaFnp8lCbjO5Uko5nV1CQACSUU9U0F732gVETBZuDH
      iGgOm6xjbD8ik7lsSLmn86AFqOgZrHb9mQm4yhXNjeMBnILQo5FP5G23KfCL8a4F
      oYXzrgcdLXHI2E+vAIPchzECAwEAAQ==
      -----END PUBLIC KEY-----